import{B as se,C as ue}from"./index-8ca571cf.js";import{b as R,a as L}from"./ocr-397e26db.js";import{s as S}from"./request-d2ecd641.js";import{b as c,s as P,c as ne}from"./enums-b2002ef1.js";import{l as ie,c as q,r as m,w as pe,o as M,z as s,N as ce,h as u,q as g,H as o,k as w,y as r,A as h,x as j,j as b,m as C,v as d,F as y,O as de,Q as W,aF as T,ah as _e,ai as me,_ as ge}from"./index-e046f3d2.js";const $=f=>(_e("data-v-d835d3cf"),f=f(),me(),f),fe=$(()=>w("div",{class:"el-upload__text"},[h(" 将文件拖到此处，或 "),w("em",null,"点击上传")],-1)),ve=$(()=>w("div",{class:"el-upload__tip"}," 支持 .zip、.tar.gz 及图片文件，最多上传 100 个。 ",-1)),be={class:"dialog-footer"},ye=".zip,.tar.gz,.jpg,.jpeg,.png,.bmp,.gif,.webp",he=ie({__name:"OcrTaskDialog",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","success","manage-repos"],setup(f,{expose:H,emit:O}){const k=f,Q=a=>{const e=["application/zip","application/x-zip-compressed","application/gzip","application/x-gzip","image/jpeg","image/png","image/bmp","image/gif","image/webp"],i=[".zip",".tar.gz",".jpg",".jpeg",".png",".bmp",".gif",".webp"],n=a.name.toLowerCase(),p=n.endsWith(".tar.gz"),x=e.includes(a.type)||p,z=i.some(v=>n.endsWith(v));return!x||!z?(T("仅支持 .zip、.tar.gz 及常见图片文件",{type:"warning"}),!1):!0},D=q({get:()=>k.modelValue,set:a=>O("update:modelValue",a)}),_=q(()=>!!k.task),V=m(),F=m(!1),E={source_type:c.GIT.value,repo_id:"",branch:"",files:[],languages:[]},l=m({...E}),J=m({source_type:[{required:!0,message:"请选择任务类型",trigger:"change"}],repository_id:[{trigger:"blur",validator:(a,e)=>l.value.source_type===c.GIT.value&&!e?new Error("请选择仓库"):!0}],branch:[{trigger:"blur",validator:(a,e)=>l.value.source_type===c.GIT.value&&!e?new Error("请选择分支"):!0}],files:[{trigger:"change",validator:(a,e)=>l.value.source_type==="upload"&&e.length===0?new Error("请上传文件"):!0}],languages:[{required:!0,message:"请选择识别语言",trigger:"blur"}]}),A=m([]),U=m([]),B=m(!1),N=()=>{var a;l.value={...E},(a=V.value)==null||a.resetFields()};pe(()=>k.task,a=>{var e;a?l.value={...E,source_type:a.source_type,repo_id:((e=a.git_repository)==null?void 0:e.toString())||"",branch:a.git_branch||"master"}:N()},{immediate:!0});const G=async()=>{try{const a=await S({apiFunc:R.list,apiParams:{}});A.value=(a==null?void 0:a.data)||[]}catch(a){console.error("获取仓库列表失败:",a)}},K=async()=>{var a;if(!l.value.repo_id){U.value=[];return}try{B.value=!0;const e=await S({apiFunc:R.getBranches,apiParams:l.value.repo_id});U.value=((a=e==null?void 0:e.data)==null?void 0:a.branches)||[]}catch(e){console.error("获取分支列表失败:",e)}finally{B.value=!1}};M(()=>{G()});const X=(a,e)=>{l.value.files=e.map(i=>i.raw)},I=()=>{D.value=!1,N()},Y=async()=>{if(V.value){await V.value.validate(),F.value=!0;try{if(_.value&&k.task){T("暂未实现编辑功能",{type:"warning"});return}let a=null,e=null;if(l.value.source_type===c.GIT.value)e={project_id:1,repo_id:Number(l.value.repo_id),branch:l.value.branch,languages:l.value.languages},a=L.createGitTask;else if(l.value.source_type===c.UPLOAD.value){if(l.value.files.length===0){T("请上传文件",{type:"warning"});return}const n=new FormData;l.value.files.forEach(p=>{n.append("file",p)}),n.append("project_id","1"),n.append("languages",String(l.value.languages)),e=n,a=L.createUploadTask}if(!a||!e){T("未知的任务类型",{type:"error"});return}const i=await S({apiFunc:a,apiParams:e,enableSucceedMsg:!0,succeedMsgContent:"任务创建成功"});(i==null?void 0:i.code)===0&&(O("success"),I())}catch(a){console.error("提交任务失败:",a)}finally{F.value=!1}}};return M(()=>{G()}),H({fetchRepositories:G}),(a,e)=>{const i=s("el-radio-button"),n=s("el-radio-group"),p=s("el-form-item"),x=s("el-option"),z=s("el-select"),v=s("el-button"),Z=s("el-icon"),ee=s("el-upload"),ae=s("el-checkbox-button"),le=s("el-checkbox-group"),te=s("el-form"),oe=s("el-dialog"),re=ce("loading");return u(),g(oe,{modelValue:D.value,"onUpdate:modelValue":e[6]||(e[6]=t=>D.value=t),title:_.value?"编辑 OCR 任务":"创建 OCR 任务",width:"720px",height:"70vh",onClose:I},{footer:o(()=>[w("div",be,[r(v,{onClick:I},{default:o(()=>[h("取消")]),_:1}),r(v,{type:"primary",onClick:Y,loading:F.value},{default:o(()=>[h(j(_.value?"保存":"创建"),1)]),_:1},8,["loading"])])]),default:o(()=>[r(te,{model:l.value,rules:J.value,ref_key:"formRef",ref:V,"label-width":"120px",class:"form-container",size:"default"},{default:o(()=>[r(p,{label:"数据源",prop:"source_type"},{default:o(()=>[r(n,{modelValue:l.value.source_type,"onUpdate:modelValue":e[0]||(e[0]=t=>l.value.source_type=t),disabled:_.value},{default:o(()=>[(u(!0),b(y,null,C(d(P)(d(c)),t=>(u(),g(i,{key:t.value,label:t.value},{default:o(()=>[h(j(t.label),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l.value.source_type===d(c).GIT.value?(u(),b(y,{key:0},[r(p,{label:"Git 仓库",prop:"repo_id"},{default:o(()=>[r(z,{modelValue:l.value.repo_id,"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.repo_id=t),placeholder:"请选择仓库",disabled:_.value,onChange:K,style:{width:"70%"},filterable:""},{default:o(()=>[(u(!0),b(y,null,C(A.value,t=>(u(),g(x,{key:t.id,label:t.url,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),r(v,{icon:d(se),type:"warning",onClick:e[2]||(e[2]=t=>a.$emit("manage-repos")),plain:"",style:{"margin-left":"10px"}},null,8,["icon"])]),_:1}),r(p,{label:"Git 分支",prop:"branch"},{default:o(()=>[de((u(),g(z,{modelValue:l.value.branch,"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.branch=t),placeholder:"请选择分支",disabled:_.value,style:{width:"70%"},filterable:""},{default:o(()=>[(u(!0),b(y,null,C(U.value,t=>(u(),g(x,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])),[[re,B.value]])]),_:1})],64)):W("",!0),l.value.source_type===d(c).UPLOAD.value&&!_.value?(u(),g(p,{key:1,label:"上传文件",prop:"files"},{default:o(()=>[r(ee,{"file-list":l.value.files,"onUpdate:fileList":e[4]||(e[4]=t=>l.value.files=t),action:"","auto-upload":!1,limit:100,multiple:"",drag:"",accept:ye,"before-upload":Q,"on-change":X},{tip:o(()=>[ve]),default:o(()=>[r(Z,{class:"el-icon--upload"},{default:o(()=>[r(d(ue))]),_:1}),fe]),_:1},8,["file-list"])]),_:1})):W("",!0),r(p,{label:"识别语言",prop:"languages"},{default:o(()=>[w("div",null,[r(le,{modelValue:l.value.languages,"onUpdate:modelValue":e[5]||(e[5]=t=>l.value.languages=t)},{default:o(()=>[(u(!0),b(y,null,C(d(P)(d(ne)),t=>(u(),g(ae,{key:t.value,label:t.label,value:t.value},{default:o(()=>[h(j(t.label),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])}}});const Ce=ge(he,[["__scopeId","data-v-d835d3cf"]]);export{Ce as default};
