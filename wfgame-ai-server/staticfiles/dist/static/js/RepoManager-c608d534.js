import{p as Q,r as W}from"./index-ccf167da.js";import{b as R}from"./ocr-8f40b38a.js";import{s as z}from"./request-2aeceb02.js";import{m as X,r as c,a0 as F,w as Y,A as s,O as Z,j as P,u as M,I as o,l as v,z as t,B as i,x as N,P as ee,y as U,R as te,aE as y,aG as ae,_ as oe}from"./index-fbbdd03e.js";const le={class:"repo-manager-container"},re={class:"toolbar"},ne={class:"pagination-wrapper"},se={class:"dialog-footer"},ie=X({__name:"RepoManager",props:{modelValue:{type:Boolean}},emits:["update:modelValue","select-repo","close"],setup(q,{emit:A}){const D=q,h=A,w=c(D.modelValue),g=c(!1),f=c([]),r=F({currentPage:1,pageSize:10,total:0}),m=c(!1),_=c(),n=F({url:"",branch:"main",token:""}),T=F({url:[{required:!0,message:"请输入仓库地址",trigger:"blur"}],branch:[{required:!0,message:"请输入默认分支",trigger:"blur"}],token:[{required:!0,message:"请输入访问令牌",trigger:"blur"}]}),C=c(!1),$=()=>{var a;m.value=!0,(a=_.value)==null||a.resetFields()},I=async()=>{_.value&&(C.value=!0,await _.value.validate(async a=>{if(a)try{const e=await z({apiFunc:R.create,apiParams:{url:n.url.trim(),branch:n.branch.trim(),token:n.token.trim()},enableSucceedMsg:!0,succeedMsgContent:"仓库添加成功",enableFailedMsg:!1});(e==null?void 0:e.code)===0?(m.value=!1,d()):(y("添加失败：请查看控制台输出的错误信息",{type:"error"}),console.error("Failed to add repository:",e))}catch(e){console.error("Failed to add repository:",e),y("添加失败，请检查仓库地址或联系管理员",{type:"error"})}finally{C.value=!1}}))},d=async()=>{g.value=!0;try{const a={page:r.currentPage,page_size:r.pageSize},e=await z({apiFunc:R.list,apiParams:a});f.value=e.data||[],r.total=f.value.length}catch(a){console.error("Failed to fetch repositories:",a),y("获取仓库列表失败",{type:"error"}),f.value=[],r.total=0}finally{g.value=!1}},O=a=>{r.currentPage=a,d()},E=a=>{r.pageSize=a,r.currentPage=1,d()},L=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",de=a=>{h("select-repo",a),V()},j=a=>{ae.confirm(`确定要删除仓库 "${a.url}" 吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await z({apiFunc:R.delete,apiParams:a.id,enableSucceedMsg:!0,succeedMsgContent:"仓库删除成功"}),d()}catch(e){console.error("Failed to delete repository:",e),y("删除失败，请稍后重试",{type:"error"})}}).catch(()=>{})},V=()=>{h("update:modelValue",!1),h("close")};return Y(()=>D.modelValue,a=>{w.value=a,a&&d()}),(a,e)=>{const S=s("el-icon"),u=s("el-button"),p=s("el-table-column"),G=s("el-table"),H=s("el-pagination"),k=s("el-input"),x=s("el-form-item"),J=s("el-form"),B=s("el-dialog"),K=Z("loading");return P(),M(B,{modelValue:w.value,"onUpdate:modelValue":e[5]||(e[5]=l=>w.value=l),title:"OCR 仓库管理",width:"60%",onClose:V},{footer:o(()=>[v("span",se,[t(u,{onClick:V},{default:o(()=>[...e[10]||(e[10]=[i("关闭",-1)])]),_:1})])]),default:o(()=>[v("div",le,[v("div",re,[t(u,{type:"primary",onClick:$},{default:o(()=>[t(S,null,{default:o(()=>[t(N(Q))]),_:1}),e[6]||(e[6]=i(" 添加仓库 ",-1))]),_:1}),t(u,{onClick:d,loading:g.value},{default:o(()=>[t(S,null,{default:o(()=>[t(N(W))]),_:1}),e[7]||(e[7]=i(" 刷新 ",-1))]),_:1},8,["loading"])]),ee((P(),M(G,{data:f.value,stripe:"",style:{width:"100%"},height:"400px"},{default:o(()=>[t(p,{prop:"id",label:"ID",width:"80"}),t(p,{prop:"url",label:"仓库地址","min-width":"250","show-overflow-tooltip":""}),t(p,{prop:"branch",label:"默认分支",width:"150"}),t(p,{prop:"created_at",label:"添加时间",width:"180"},{default:o(({row:l})=>[i(U(L(l.created_at)),1)]),_:1}),t(p,{prop:"created_by",label:"添加者",width:"120"},{default:o(({row:l})=>{var b;return[i(U(((b=l.created_by)==null?void 0:b.username)||"-"),1)]}),_:1}),t(p,{label:"操作",fixed:"right",width:"150"},{default:o(({row:l})=>[te("",!0),t(u,{type:"danger",size:"small",text:"",onClick:b=>j(l)},{default:o(()=>[...e[9]||(e[9]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[K,g.value]]),v("div",ne,[t(H,{"current-page":r.currentPage,"page-size":r.pageSize,total:r.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onSizeChange:E,onCurrentChange:O},null,8,["current-page","page-size","total"])])]),t(B,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=l=>m.value=l),title:"添加新仓库",width:"40%","append-to-body":""},{footer:o(()=>[t(u,{onClick:e[3]||(e[3]=l=>m.value=!1)},{default:o(()=>[...e[11]||(e[11]=[i("取消",-1)])]),_:1}),t(u,{loading:C.value,type:"primary",onClick:I},{default:o(()=>[...e[12]||(e[12]=[i(" 确定 ",-1)])]),_:1},8,["loading"])]),default:o(()=>[t(J,{model:n,rules:T,ref_key:"newRepoFormRef",ref:_,"label-width":"100px"},{default:o(()=>[t(x,{label:"仓库地址",prop:"url"},{default:o(()=>[t(k,{modelValue:n.url,"onUpdate:modelValue":e[0]||(e[0]=l=>n.url=l),placeholder:"例如：https://github.com/user/repo.git"},null,8,["modelValue"])]),_:1}),t(x,{label:"访问令牌",prop:"token"},{default:o(()=>[t(k,{modelValue:n.token,"onUpdate:modelValue":e[1]||(e[1]=l=>n.token=l),placeholder:"仓库的访问令牌",type:"password"},null,8,["modelValue"])]),_:1}),t(x,{label:"默认分支",prop:"branch"},{default:o(()=>[t(k,{modelValue:n.branch,"onUpdate:modelValue":e[2]||(e[2]=l=>n.branch=l),placeholder:"例如：main"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}});const ge=oe(ie,[["__scopeId","data-v-133e0c24"]]);export{ge as default};
