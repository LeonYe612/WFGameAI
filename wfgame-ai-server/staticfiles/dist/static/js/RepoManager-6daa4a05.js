import{p as J,r as K}from"./index-8ca571cf.js";import{b as z}from"./ocr-397e26db.js";import{s as R}from"./request-d2ecd641.js";import{l as W,r as p,$ as F,w as X,z as s,N as Y,h as M,q as P,H as o,k as v,y as e,A as i,v as N,O as Z,x as q,Q as ee,aF as b,aO as ae,_ as te}from"./index-e046f3d2.js";const oe={class:"repo-manager-container"},le={class:"toolbar"},re={class:"pagination-wrapper"},ne={class:"dialog-footer"},se=W({__name:"RepoManager",props:{modelValue:{type:Boolean}},emits:["update:modelValue","select-repo","close"],setup(U,{emit:y}){const D=U,w=p(D.modelValue),_=p(!1),g=p([]),r=F({currentPage:1,pageSize:10,total:0}),m=p(!1),f=p(),n=F({url:"",branch:"main",token:""}),$=F({url:[{required:!0,message:"请输入仓库地址",trigger:"blur"}],branch:[{required:!0,message:"请输入默认分支",trigger:"blur"}],token:[{required:!0,message:"请输入访问令牌",trigger:"blur"}]}),C=p(!1),A=()=>{var a;m.value=!0,(a=f.value)==null||a.resetFields()},O=async()=>{f.value&&(C.value=!0,await f.value.validate(async a=>{if(a)try{const t=await R({apiFunc:z.create,apiParams:{url:n.url.trim(),branch:n.branch.trim(),token:n.token.trim()},enableSucceedMsg:!0,succeedMsgContent:"仓库添加成功",enableFailedMsg:!1});(t==null?void 0:t.code)===0?(m.value=!1,d()):(b("添加失败：请查看控制台输出的错误信息",{type:"error"}),console.error("Failed to add repository:",t))}catch(t){console.error("Failed to add repository:",t),b("添加失败，请检查仓库地址或联系管理员",{type:"error"})}finally{C.value=!1}}))},d=async()=>{_.value=!0;try{const a={page:r.currentPage,page_size:r.pageSize},t=await R({apiFunc:z.list,apiParams:a});g.value=t.data||[],r.total=g.value.length}catch(a){console.error("Failed to fetch repositories:",a),b("获取仓库列表失败",{type:"error"}),g.value=[],r.total=0}finally{_.value=!1}},T=a=>{r.currentPage=a,d()},I=a=>{r.pageSize=a,r.currentPage=1,d()},L=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",ie=a=>{y("select-repo",a),V()},E=a=>{ae.confirm(`确定要删除仓库 "${a.url}" 吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await R({apiFunc:z.delete,apiParams:a.id,enableSucceedMsg:!0,succeedMsgContent:"仓库删除成功"}),d()}catch(t){console.error("Failed to delete repository:",t),b("删除失败，请稍后重试",{type:"error"})}}).catch(()=>{})},V=()=>{y("update:modelValue",!1),y("close")};return X(()=>D.modelValue,a=>{w.value=a,a&&d()}),(a,t)=>{const S=s("el-icon"),u=s("el-button"),c=s("el-table-column"),H=s("el-table"),Q=s("el-pagination"),k=s("el-input"),x=s("el-form-item"),j=s("el-form"),B=s("el-dialog"),G=Y("loading");return M(),P(B,{modelValue:w.value,"onUpdate:modelValue":t[5]||(t[5]=l=>w.value=l),title:"OCR 仓库管理",width:"60%",onClose:V},{footer:o(()=>[v("span",ne,[e(u,{onClick:V},{default:o(()=>[i("关闭")]),_:1})])]),default:o(()=>[v("div",oe,[v("div",le,[e(u,{type:"primary",onClick:A},{default:o(()=>[e(S,null,{default:o(()=>[e(N(J))]),_:1}),i(" 添加仓库 ")]),_:1}),e(u,{onClick:d,loading:_.value},{default:o(()=>[e(S,null,{default:o(()=>[e(N(K))]),_:1}),i(" 刷新 ")]),_:1},8,["loading"])]),Z((M(),P(H,{data:g.value,stripe:"",style:{width:"100%"},height:"400px"},{default:o(()=>[e(c,{prop:"id",label:"ID",width:"80"}),e(c,{prop:"url",label:"仓库地址","min-width":"250","show-overflow-tooltip":""}),e(c,{prop:"branch",label:"默认分支",width:"150"}),e(c,{prop:"created_at",label:"添加时间",width:"180"},{default:o(({row:l})=>[i(q(L(l.created_at)),1)]),_:1}),e(c,{prop:"created_by",label:"添加者",width:"120"},{default:o(({row:l})=>{var h;return[i(q(((h=l.created_by)==null?void 0:h.username)||"-"),1)]}),_:1}),e(c,{label:"操作",fixed:"right",width:"150"},{default:o(({row:l})=>[ee("",!0),e(u,{type:"danger",size:"small",text:"",onClick:h=>E(l)},{default:o(()=>[i(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[G,_.value]]),v("div",re,[e(Q,{"current-page":r.currentPage,"page-size":r.pageSize,total:r.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onSizeChange:I,onCurrentChange:T},null,8,["current-page","page-size","total"])])]),e(B,{modelValue:m.value,"onUpdate:modelValue":t[4]||(t[4]=l=>m.value=l),title:"添加新仓库",width:"40%","append-to-body":""},{footer:o(()=>[e(u,{onClick:t[3]||(t[3]=l=>m.value=!1)},{default:o(()=>[i("取消")]),_:1}),e(u,{loading:C.value,type:"primary",onClick:O},{default:o(()=>[i(" 确定 ")]),_:1},8,["loading"])]),default:o(()=>[e(j,{model:n,rules:$,ref_key:"newRepoFormRef",ref:f,"label-width":"100px"},{default:o(()=>[e(x,{label:"仓库地址",prop:"url"},{default:o(()=>[e(k,{modelValue:n.url,"onUpdate:modelValue":t[0]||(t[0]=l=>n.url=l),placeholder:"例如：https://github.com/user/repo.git"},null,8,["modelValue"])]),_:1}),e(x,{label:"访问令牌",prop:"token"},{default:o(()=>[e(k,{modelValue:n.token,"onUpdate:modelValue":t[1]||(t[1]=l=>n.token=l),placeholder:"仓库的访问令牌",type:"password"},null,8,["modelValue"])]),_:1}),e(x,{label:"默认分支",prop:"branch"},{default:o(()=>[e(k,{modelValue:n.branch,"onUpdate:modelValue":t[2]||(t[2]=l=>n.branch=l),placeholder:"例如：main"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}});const me=te(se,[["__scopeId","data-v-133e0c24"]]);export{me as default};
