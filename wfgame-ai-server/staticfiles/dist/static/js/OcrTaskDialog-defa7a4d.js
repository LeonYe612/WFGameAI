import{C as ue,D as ne}from"./index-0964a6d0.js";import{b as L,a as N}from"./ocr-1edae99a.js";import{s as j}from"./request-28f7529e.js";import{b as d,s as P,c as se}from"./enums-b2002ef1.js";import{m as ie,d as S,r as f,w as pe,o as M,A as u,O as de,j as n,u as _,I as o,l as b,z as r,B as y,y as O,k as h,p as C,x as c,F as w,P as ce,R as q,aE as D,_ as me}from"./index-41f05ddf.js";const ge={class:"dialog-footer"},fe=".zip,.tar.gz,.jpg,.jpeg,.png,.bmp,.gif,.webp",_e=ie({__name:"OcrTaskDialog",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","success","manage-repos"],setup(W,{expose:$,emit:H}){const J=a=>{const e=["application/zip","application/x-zip-compressed","application/gzip","application/x-gzip","image/jpeg","image/png","image/bmp","image/gif","image/webp"],i=[".zip",".tar.gz",".jpg",".jpeg",".png",".bmp",".gif",".webp"],s=a.name.toLowerCase(),p=s.endsWith(".tar.gz"),x=e.includes(a.type)||p,z=i.some(v=>s.endsWith(v));return!x||!z?(D("仅支持 .zip、.tar.gz 及常见图片文件",{type:"warning"}),!1):!0},k=W,R=H,E=S({get:()=>k.modelValue,set:a=>R("update:modelValue",a)}),m=S(()=>!!k.task),V=f(),T=f(!1),F={source_type:d.GIT.value,repo_id:"",branch:"",files:[],languages:[]},l=f({...F}),K=f({source_type:[{required:!0,message:"请选择任务类型",trigger:"change"}],repo_id:[{trigger:"blur",validator:(a,e)=>l.value.source_type===d.GIT.value&&!e?new Error("请选择仓库"):!0}],branch:[{trigger:"blur",validator:(a,e)=>l.value.source_type!==d.GIT.value?!0:e?!g.value||!g.value.length?new Error("请先选择仓库并加载分支"):g.value.includes(e)?!0:new Error("所选分支无效，请重新选择"):new Error("请选择分支")}],files:[{trigger:"change",validator:(a,e)=>l.value.source_type==="upload"&&e.length===0?new Error("请上传文件"):!0}],languages:[{required:!0,message:"请选择识别语言",trigger:"blur"}]}),A=f([]),g=f([]),U=f(!1),I=()=>{var a;l.value={...F},(a=V.value)==null||a.resetFields()};pe(()=>k.task,a=>{var e;a?l.value={...F,source_type:a.source_type,repo_id:((e=a.git_repository)==null?void 0:e.toString())||"",branch:a.git_branch||"master"}:I()},{immediate:!0});const B=async()=>{try{const a=await j({apiFunc:L.list,apiParams:{}});A.value=(a==null?void 0:a.data)||[]}catch(a){console.error("获取仓库列表失败:",a)}},Q=async()=>{var a;if(!l.value.repo_id){g.value=[];return}try{U.value=!0;const e=await j({apiFunc:L.getBranches,apiParams:l.value.repo_id});g.value=((a=e==null?void 0:e.data)==null?void 0:a.branches)||[],g.value.includes(l.value.branch)||(l.value.branch="")}catch(e){console.error("获取分支列表失败:",e)}finally{U.value=!1}};M(()=>{B()});const X=(a,e)=>{l.value.files=e.map(i=>i.raw)},G=()=>{E.value=!1,I()},Y=async()=>{if(V.value){await V.value.validate(),T.value=!0;try{if(m.value&&k.task){D("暂未实现编辑功能",{type:"warning"});return}let a=null,e=null;if(l.value.source_type===d.GIT.value)e={project_id:1,repo_id:Number(l.value.repo_id),branch:l.value.branch,languages:l.value.languages},a=N.createGitTask;else if(l.value.source_type===d.UPLOAD.value){if(l.value.files.length===0){D("请上传文件",{type:"warning"});return}const s=new FormData;l.value.files.forEach(p=>{s.append("file",p)}),s.append("project_id","1"),s.append("languages",String(l.value.languages)),e=s,a=N.createUploadTask}if(!a||!e){D("未知的任务类型",{type:"error"});return}const i=await j({apiFunc:a,apiParams:e,enableSucceedMsg:!0,succeedMsgContent:"任务创建成功"});(i==null?void 0:i.code)===0&&(R("success"),G())}catch(a){console.error("提交任务失败:",a)}finally{T.value=!1}}};return M(()=>{B()}),$({fetchRepositories:B}),(a,e)=>{const i=u("el-radio-button"),s=u("el-radio-group"),p=u("el-form-item"),x=u("el-option"),z=u("el-select"),v=u("el-button"),Z=u("el-icon"),ee=u("el-upload"),ae=u("el-checkbox-button"),le=u("el-checkbox-group"),te=u("el-form"),oe=u("el-dialog"),re=de("loading");return n(),_(oe,{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=t=>E.value=t),title:m.value?"编辑 OCR 任务":"创建 OCR 任务",width:"720px",height:"70vh",onClose:G},{footer:o(()=>[b("div",ge,[r(v,{onClick:G},{default:o(()=>[...e[9]||(e[9]=[y("取消",-1)])]),_:1}),r(v,{type:"primary",onClick:Y,loading:T.value},{default:o(()=>[y(O(m.value?"保存":"创建"),1)]),_:1},8,["loading"])])]),default:o(()=>[r(te,{model:l.value,rules:K.value,ref_key:"formRef",ref:V,"label-width":"120px",class:"form-container",size:"default"},{default:o(()=>[r(p,{label:"数据源",prop:"source_type"},{default:o(()=>[r(s,{modelValue:l.value.source_type,"onUpdate:modelValue":e[0]||(e[0]=t=>l.value.source_type=t),disabled:m.value},{default:o(()=>[(n(!0),h(w,null,C(c(P)(c(d)),t=>(n(),_(i,{key:t.value,label:t.value},{default:o(()=>[y(O(t.label),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l.value.source_type===c(d).GIT.value?(n(),h(w,{key:0},[r(p,{label:"Git 仓库",prop:"repo_id"},{default:o(()=>[r(z,{modelValue:l.value.repo_id,"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.repo_id=t),placeholder:"请选择仓库",disabled:m.value,onChange:Q,style:{width:"70%"},filterable:""},{default:o(()=>[(n(!0),h(w,null,C(A.value,t=>(n(),_(x,{key:t.id,label:t.url,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),r(v,{icon:c(ue),type:"warning",onClick:e[2]||(e[2]=t=>a.$emit("manage-repos")),plain:"",style:{"margin-left":"10px"}},null,8,["icon"])]),_:1}),r(p,{label:"Git 分支",prop:"branch"},{default:o(()=>[ce((n(),_(z,{modelValue:l.value.branch,"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.branch=t),placeholder:"请选择分支",disabled:m.value,style:{width:"70%"},filterable:""},{default:o(()=>[(n(!0),h(w,null,C(g.value,t=>(n(),_(x,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])),[[re,U.value]])]),_:1})],64)):q("",!0),l.value.source_type===c(d).UPLOAD.value&&!m.value?(n(),_(p,{key:1,label:"上传文件",prop:"files"},{default:o(()=>[r(ee,{"file-list":l.value.files,"onUpdate:fileList":e[4]||(e[4]=t=>l.value.files=t),action:"","auto-upload":!1,limit:100,multiple:"",drag:"",accept:fe,"before-upload":J,"on-change":X},{tip:o(()=>[...e[7]||(e[7]=[b("div",{class:"el-upload__tip"}," 支持 .zip、.tar.gz 及图片文件，最多上传 100 个。 ",-1)])]),default:o(()=>[r(Z,{class:"el-icon--upload"},{default:o(()=>[r(c(ne))]),_:1}),e[8]||(e[8]=b("div",{class:"el-upload__text"},[y(" 将文件拖到此处，或 "),b("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})):q("",!0),r(p,{label:"识别语言",prop:"languages"},{default:o(()=>[b("div",null,[r(le,{modelValue:l.value.languages,"onUpdate:modelValue":e[5]||(e[5]=t=>l.value.languages=t)},{default:o(()=>[(n(!0),h(w,null,C(c(P)(c(se)),t=>(n(),_(ae,{key:t.value,label:t.value},{default:o(()=>[y(O(t.label),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])}}});const ke=me(_e,[["__scopeId","data-v-a4efad76"]]);export{ke as default};
