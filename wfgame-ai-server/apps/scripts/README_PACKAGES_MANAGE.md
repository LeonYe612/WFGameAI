# 安装包管理模块设计方案

## 1. 功能概述

**安装包管理**模块将为WFGameAI测试系统提供统一的APK文件管理功能，它将作为连接应用生命周期管理和测试执行的关键组件。

### 核心功能

1. **统一管理APK文件**
   - 集中存储所有测试应用的APK文件
   - 提供APK上传、下载、删除功能
   - 支持APK版本管理和历史记录

2. **智能安装包选择**
   - 在录制/回放/调试时快速选择需要测试的应用
   - 提供最近使用的应用快速访问
   - 按类别、名称、版本等筛选应用

3. **自动解析APK信息**
   - 提取包名、活动名、版本等关键信息
   - 生成应用模板配置
   - 识别权限需求和兼容性信息

4. **应用生命周期集成**
   - 与`AppLifecycleManager`无缝集成
   - 一键安装、启动、停止、卸载应用
   - 监控应用状态和崩溃信息

### 扩展功能

5. **设备兼容性检查**
   - 检查APK与设备的架构、API级别兼容性
   - 多设备批量安装支持
   - 提供设备-应用兼容性报告

6. **测试用例关联**
   - 将测试脚本与特定应用版本关联
   - 管理应用的测试套件
   - 追踪每个应用版本的测试覆盖率

7. **性能监控**
   - 收集应用启动时间、内存使用等指标
   - 比较不同版本的性能变化
   - 生成性能报告和趋势图

8. **自动化部署**
   - 定时检查并更新应用新版本
   - CI/CD流程集成
   - 构建-测试-部署自动化流程

## 2. 数据模型设计

### APK文件信息表
```
- id: 唯一标识符
- name: 应用名称
- package_name: 包名
- version_name: 版本名称(如1.2.3)
- version_code: 版本号(如123)
- file_path: 文件存储路径
- file_size: 文件大小
- upload_time: 上传时间
- uploaded_by: 上传用户
- main_activity: 主活动名
- min_sdk: 最小SDK版本
- target_sdk: 目标SDK版本
- description: 描述信息
- icon_path: 图标存储路径
- status: 状态(活跃/归档/弃用)
- md5_hash: MD5校验和
```

### 安装记录表
```
- id: 唯一标识符
- apk_id: APK文件ID
- device_id: 设备ID
- install_time: 安装时间
- install_status: 安装状态
- uninstall_time: 卸载时间(可为空)
- install_log: 安装日志
```

### 应用使用记录表
```
- id: 唯一标识符
- apk_id: APK文件ID
- device_id: 设备ID
- test_script_id: 测试脚本ID
- start_time: 启动时间
- end_time: 结束时间
- status: 状态(成功/失败/崩溃)
- performance_data: 性能数据JSON
```

## 3. 系统架构

### 组件划分

1. **存储管理器**
   - 处理APK文件的物理存储
   - 实现文件上传/下载/删除功能
   - 管理文件存储空间和备份

2. **APK解析器**
   - 提取APK文件信息
   - 生成应用模板
   - 检查应用签名和完整性

3. **设备集成器**
   - 处理设备与应用的兼容性
   - 管理应用在设备上的安装状态
   - 协调多设备测试

4. **UI界面**
   - 应用列表视图
   - 应用详情页面
   - 应用选择对话框
   - 上传和管理界面

5. **API服务**
   - 提供RESTful API接口
   - 支持外部系统集成
   - 处理权限和认证

## 4. 业务流程

### 应用上传流程
1. 用户上传APK文件
2. 系统解析APK提取信息
3. 存储APK并记录元数据
4. 生成应用模板配置
5. 返回上传结果

### 应用安装流程
1. 用户选择应用和目标设备
2. 系统检查兼容性
3. 执行安装命令
4. 验证安装结果
5. 更新安装记录

### 测试执行流程
1. 用户选择测试脚本和应用
2. 系统准备测试环境
3. 安装应用(如需要)
4. 启动应用
5. 执行测试脚本
6. 收集测试结果
7. 生成测试报告

## 5. 与现有模块的集成

### 与脚本管理模块集成
- 脚本可以引用特定应用版本
- 测试执行时自动选择正确的应用版本
- 脚本可以指定应用依赖关系

### 与设备管理模块集成
- 设备信息页面显示已安装应用
- 设备操作中添加应用管理选项
- 设备状态监控包含应用运行状态

### 与报告模块集成
- 测试报告关联应用版本信息
- 应用性能数据纳入报告
- 支持按应用筛选报告

## 6. 用户界面设计

### 应用列表页面
- 显示所有已上传的应用
- 分类筛选和搜索功能
- 显示应用图标、名称、版本等基本信息
- 快速操作按钮(安装、启动、删除等)

### 应用详情页面
- 显示应用的详细信息
- 版本历史记录
- 安装记录和使用统计
- 关联的测试脚本
- 性能数据图表

### 应用选择对话框
- 在录制/回放/调试时使用
- 显示最近使用的应用
- 快速搜索功能
- 显示应用与当前设备的兼容性

## 7. 安全考虑

1. **应用验证**
   - 检查APK签名完整性
   - 扫描潜在恶意代码
   - 权限审核和提醒

2. **访问控制**
   - 基于角色的应用管理权限
   - 操作审计和日志
   - 敏感操作需要额外确认

3. **数据安全**
   - APK文件加密存储
   - 防止未授权访问
   - 定期备份重要数据

## 8. 实现路线图

### 第一阶段: 基础功能
- APK上传和基本信息提取
- 简单的应用列表和管理界面
- 与AppLifecycleManager的基本集成

### 第二阶段: 增强功能
- 完整的APK解析和信息展示
- 设备兼容性检查
- 版本管理和历史记录

### 第三阶段: 高级功能
- 应用性能监控
- 测试套件关联
- 自动化部署集成
- 数据分析和报告

## 9. 预期效益

1. **提高测试效率**
   - 减少手动安装和管理应用的时间
   - 自动化应用部署和版本管理
   - 快速定位应用问题

2. **增强测试质量**
   - 确保测试使用正确的应用版本
   - 全面记录测试环境和条件
   - 提供更完整的测试覆盖

3. **优化用户体验**
   - 简化应用选择和管理流程
   - 提供直观的应用信息和状态
   - 减少测试准备工作

4. **支持更复杂的测试场景**
   - 多应用协同测试
   - A/B测试不同应用版本
   - 性能对比测试

