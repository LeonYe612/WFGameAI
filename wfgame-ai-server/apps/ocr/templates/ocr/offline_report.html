<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OCR 离线报告 - {{ task.id }}</title>
    <style>
      {{ element_css|safe }}
    </style>
    <script>
      {{ vue_js|safe }}
    </script>
    <script>
      {{ element_js|safe }}
    </script>
    <script>
      {{ element_icons_js|safe }}
    </script>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #f5f7fa;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        overflow: hidden;
      }
      #app {
        height: 100%;
      }
      .main-container {
        height: 100%;
      }
      .header-container {
        background-color: #fff;
        border-bottom: 1px solid #dcdfe6;
        padding: 10px 20px;
        height: auto !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        z-index: 10;
      }
      .content-container {
        padding: 20px;
        overflow-y: auto;
        background-color: #f0f2f5;
      }
      
      /* Filter Styles */
      .filter-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 10px;
      }
      .filter-groups-left {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 24px;
      }
      .filter-group-item {
        display: flex;
        align-items: center;
      }
      .label-text {
        font-size: 14px;
        color: #606266;
        margin-right: 6px;
        font-weight: 500;
      }

      /* Card Styles */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
      }
      .result-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: all 0.3s;
      }
      .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .result-card .el-card__body {
        padding: 0;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .card-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .image-container {
        flex-shrink: 0;
        padding: 6px;
        border-bottom: 1px solid #e4e7ed;
        position: relative;
        background-color: #f5f7fa;
      }
      .image-wrapper {
        position: relative;
        height: 200px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
      .info-container {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .image-name {
        font-size: 15px;
        font-weight: bold;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #303133;
      }
      .ocr-text-box {
        background-color: #f5f7fa;
        padding: 8px;
        border-radius: 4px;
        font-size: 13px;
        color: #606266;
        min-height: 40px;
        max-height: 80px;
        overflow-y: auto;
        border: 1px solid #e4e7ed;
      }
      .translation-input {
        margin-top: auto;
      }
      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #ebeef5;
      }
      
      /* Ignored State */
      .result-card.is-ignored {
        opacity: 0.75;
        background-color: #e0e0e0;
        border-color: #d6d6d6;
        filter: grayscale(0.9);
        transition: all 0.3s ease;
      }
      .result-card.is-ignored:hover {
        opacity: 0.9;
        filter: grayscale(0);
      }
      
      .ignored-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        pointer-events: none;
      }

      .ignored-overlay span {
        background-color: rgba(144, 147, 153, 0.9);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        letter-spacing: 1px;
      }
      
      .pagination-wrapper {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        background-color: #fff;
        padding: 10px;
        border-radius: 4px;
      }
      
      .desc-label {
        font-weight: bold;
        color: #606266;
      }
    </style>
    <!-- 数据注入点 -->
    <script id="data-injection">
      window.__LOCAL_DATA__ = null;
    </script>
  </head>
  <body>
    <div id="app">Loading...</div>
    {% verbatim %}
    <script type="text/x-template" id="app-template">
      <el-container class="main-container">
        <el-header class="header-container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h3 style="margin: 0;">OCR 离线报告</h3>
                    <el-tag size="small">{{ task.id }}</el-tag>
                    <el-tag size="small" type="info">生成时间: {{ formatTime(new Date()) }}</el-tag>
                    <el-button type="primary" link @click="showFilterInfo = !showFilterInfo">
                        {{ showFilterInfo ? '隐藏导出条件' : '查看导出条件' }}
                    </el-button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <el-button type="success" @click="saveToFile">
                        保存更改到文件
                    </el-button>
                </div>
            </div>
            
            <el-collapse-transition>
                <div v-show="showFilterInfo" style="margin-top: 10px; margin-bottom: 10px; border-top: 1px solid #ebeef5; padding-top: 10px;">
                    <el-descriptions title="本次导出筛选条件" :column="4" border size="small">
                        <el-descriptions-item label="匹配状态" label-class-name="desc-label">
                            {{ formatFilterValue(exportFilterData.has_match, '匹配') }}
                        </el-descriptions-item>
                        <el-descriptions-item label="翻译状态" label-class-name="desc-label">
                            {{ formatFilterValue(exportFilterData.is_translated, '翻译') }}
                        </el-descriptions-item>
                        <el-descriptions-item label="审核状态" label-class-name="desc-label">
                            {{ formatFilterValue(exportFilterData.is_verified, '审核') }}
                        </el-descriptions-item>
                        <el-descriptions-item label="结果标记" label-class-name="desc-label">
                            {{ getResultTypeLabel(exportFilterData.result_type) }}
                        </el-descriptions-item>
                        <el-descriptions-item label="关键字" label-class-name="desc-label" :span="4">
                            {{ exportFilterData.keyword || '无' }}
                        </el-descriptions-item>
                    </el-descriptions>
                </div>
            </el-collapse-transition>

            <div class="filter-toolbar">
                <div class="filter-groups-left">
                    <div class="filter-group-item">
                        <el-input
                            v-model="filterData.keyword"
                            placeholder="搜索文件名..."
                            :prefix-icon="Search"
                            clearable
                            style="width: 240px"
                            @input="handleSearch"
                        />
                    </div>
                    <div class="filter-group-item">
                        <span class="label-text">需要翻译：</span>
                        <el-radio-group v-model="filterData.noTranslation" @change="handleSearch" size="small">
                            <el-radio-button :label="null">全部</el-radio-button>
                            <el-radio-button :label="false">是</el-radio-button>
                            <el-radio-button :label="true">否</el-radio-button>
                        </el-radio-group>
                    </div>
                    <div class="filter-group-item">
                        <span class="label-text">已填写翻译：</span>
                        <el-radio-group v-model="filterData.hasTranslation" @change="handleSearch" size="small">
                            <el-radio-button :label="null">全部</el-radio-button>
                            <el-radio-button :label="true">是</el-radio-button>
                            <el-radio-button :label="false">否</el-radio-button>
                        </el-radio-group>
                    </div>
                </div>
                <div class="filter-actions">
                    <el-button :icon="RefreshLeft" circle @click="handleReset" title="重置筛选"></el-button>
                </div>
            </div>
        </el-header>

        <el-main class="content-container">
            <div class="card-grid">
                <div v-for="item in paginatedResults" :key="item.id">
                    <el-card shadow="hover" class="result-card" :class="{ 'is-ignored': isNoTranslation(item.id) }">
                        <div class="card-content">
                            <div class="image-container">
                                <div class="image-wrapper">
                                    <el-image
                                        :src="item.image_url"
                                        :preview-src-list="[item.image_url]"
                                        fit="contain"
                                        lazy
                                        style="width: 100%; height: 100%"
                                        hide-on-click-modal
                                        :preview-teleported="true"
                                    ></el-image>
                                    <div v-if="isNoTranslation(item.id)" class="ignored-overlay">
                                        <span>无需翻译</span>
                                    </div>
                                </div>
                            </div>
                            <div class="info-container">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div class="image-name" :title="getImgName(item.image_path)">
                                        {{ getImgName(item.image_path) }}
                                    </div>
                                </div>
                                
                                <div class="ocr-text-box" title="OCR识别文本">
                                    {{ getResultText(item) || "（无识别文本）" }}
                                </div>

                                <div class="translation-input">
                                    <el-input
                                        v-model="localData[item.id].translation"
                                        type="textarea"
                                        :rows="2"
                                        placeholder="请输入翻译文本..."
                                        :disabled="isNoTranslation(item.id)"
                                    ></el-input>
                                </div>

                                <div class="action-bar">
                                    <el-radio-group v-model="localData[item.id].noTranslation" size="">
                                        <el-radio-button :label="false">✅需要翻译</el-radio-button>
                                        <el-radio-button :label="true">❌无需翻译</el-radio-button>
                                    </el-radio-group>
                                    <el-tag size="" type="info">{{ item.pic_resolution || '未知分辨率' }}</el-tag>
                                </div>
                            </div>
                        </div>
                    </el-card>
                </div>
            </div>

            <div class="pagination-wrapper">
                <el-pagination
                    v-model:current-page="pagination.currentPage"
                    v-model:page-size="pagination.pageSize"
                    :total="pagination.total"
                    :page-sizes="[20, 50, 100, 200]"
                    layout="total, sizes, prev, pager, next, jumper"
                    @size-change="handleSizeChange"
                    @current-change="handlePageChange"
                    background
                />
            </div>
            <el-empty v-if="paginatedResults.length === 0" description="暂无数据"></el-empty>
        </el-main>
      </el-container>
    </script>
    {% endverbatim %}

    <script>
      const { createApp, ref, computed, reactive, watch, onMounted } = Vue;
      const { Search, RefreshLeft } = ElementPlusIconsVue;

      const App = {
        template: '#app-template',
        setup() {
          const task = {{ task_json|safe }};
          const allResults = {{ results_json|safe }};
          const exportFilterData = {{ filter_data_json|safe }};
          const enums = {{ enums_json|safe }};
          
          // Local Data State
          const localData = reactive({});
          
          // Initialize local data
          // 优先使用注入的数据，否则初始化为空
          const injectedData = window.__LOCAL_DATA__;
          
          allResults.forEach(item => {
              if (injectedData && injectedData[item.id]) {
                  localData[item.id] = injectedData[item.id];
              } else {
                  localData[item.id] = {
                      noTranslation: false,
                      translation: ''
                  };
              }
          });

          const saveToFile = () => {
              try {
                  // 1. 获取当前 HTML 内容
                  let htmlContent = document.documentElement.outerHTML;
                  
                  // 2. 准备要注入的数据
                  const dataScript = `window.__LOCAL_DATA__ = ${JSON.stringify(localData)};`;
                  
                  // 3. 替换注入点
                  // 使用正则替换 script 标签内容
                  const regex = /<script id="data-injection">[\s\S]*?<\/script>/;
                  const replacement = `<script id="data-injection">${dataScript}<\/script>`;
                  
                  htmlContent = htmlContent.replace(regex, replacement);
                  
                  // 4. 创建 Blob 并下载
                  const blob = new Blob([htmlContent], { type: 'text/html' });
                  const url = URL.createObjectURL(blob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = `ocr_report_${task.id}_saved_${new Date().getTime()}.html`;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  URL.revokeObjectURL(url);
                  
                  ElementPlus.ElMessageBox.alert(
                    '数据已成功保存到新文件中。请注意：后续如需继续变更，请打开新下载的文件进行操作，当前文件的修改无法直接保存到本地。',
                    '保存成功',
                    {
                      confirmButtonText: '我知道了',
                      type: 'success',
                    }
                  );
              } catch (e) {
                  console.error("Failed to save file", e);
                  ElementPlus.ElMessage.error('保存文件失败');
              }
          };

          const showFilterInfo = ref(false);
          
          const filterData = reactive({
            keyword: '',
            noTranslation: null,
            hasTranslation: null
          });

          const pagination = reactive({
            currentPage: 1,
            pageSize: 50,
            total: allResults.length
          });

          const filteredResults = ref([...allResults]);

          const handleSearch = () => {
            pagination.currentPage = 1;
            const results = allResults.filter(item => {
              const itemData = localData[item.id];
              
              // Keyword - 只搜索文件名
              if (filterData.keyword) {
                  const name = getImgName(item.image_path).toLowerCase();
                  const kw = filterData.keyword.toLowerCase();
                  if (!name.includes(kw)) return false;
              }

              // No Translation
              if (filterData.noTranslation !== null) {
                  if (itemData.noTranslation !== filterData.noTranslation) return false;
              }

              // Has Translation
              if (filterData.hasTranslation !== null) {
                  const hasTrans = !!(itemData.translation && itemData.translation.trim());
                  if (hasTrans !== filterData.hasTranslation) return false;
              }

              return true;
            });

            filteredResults.value = results;
            pagination.total = results.length;
          };

          const handleReset = () => {
            filterData.keyword = "";
            filterData.noTranslation = null;
            filterData.hasTranslation = null;
            handleSearch();
          };

          const paginatedResults = computed(() => {
            const start = (pagination.currentPage - 1) * pagination.pageSize;
            const end = start + pagination.pageSize;
            return filteredResults.value.slice(start, end);
          });

          const handleSizeChange = (size) => {
            pagination.pageSize = size;
            pagination.currentPage = 1;
          };

          const handlePageChange = (page) => {
            pagination.currentPage = page;
            document.querySelector('.content-container').scrollTop = 0;
          };

          // Helpers
          const getImgName = (path) => path ? path.split('/').pop() : '未知图片';

          const getResultText = (item) => {
               let texts = "";
               if (item.result_type === 1) {
                // 正确结果取：texts
                texts = item.texts;
               } else if (item.result_type === 2) {
                // 错误结果取：correct_texts
                texts = item.correct_texts;
               } else {
                // 其他结果取 texts 优先
                texts = ""
               }
               if (!texts) return "";
               if (Array.isArray(item.texts)) return item.texts.join('');
               return texts;
          };
          
          const isNoTranslation = (id) => {
              return localData[id]?.noTranslation;
          };

          const formatTime = (timeStr) => {
              if (!timeStr) return '-';
              return new Date(timeStr).toLocaleString();
          };
          
          const formatFilterValue = (val, prefix) => {
              if (val === null || val === undefined) return '全部';
              if (val === true) return `已${prefix}`;
              if (val === false) return `未${prefix}`;
              return val;
          };
          
          const getResultTypeLabel = (val) => {
              if (!val) return '全部';
              const typeEnum = enums.ocrResultTypeEnum;
              for (const key in typeEnum) {
                  if (typeEnum[key].value == val) return typeEnum[key].label;
              }
              return val;
          };

          return {
            task,
            exportFilterData,
            localData,
            filterData,
            pagination,
            paginatedResults,
            showFilterInfo,
            Search, RefreshLeft,
            handleSearch,
            handleReset,
            handleSizeChange,
            handlePageChange,
            saveToFile,
            getImgName,
            getResultText,
            isNoTranslation,
            formatTime,
            formatFilterValue,
            getResultTypeLabel
          };
        }
      };

      const app = createApp(App);
      app.use(ElementPlus);
      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component)
      }
      app.mount('#app');
    </script>
  </body>
</html>
